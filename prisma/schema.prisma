generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
  engine   = "client"
}

datasource db {
  provider = "postgresql"
  schemas  = ["public", "auth"]
}

model Session {
  id        String   @id @default(uuid()) @db.Uuid
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("auth")
}

enum UserStatus {
  ACTIVO
  INACTIVO

  @@schema("auth")
}

enum Role {
  ADMIN
  ASESOR

  @@schema("auth")
}

model User {
  id                   String     @id @default(uuid()) @db.Uuid
  name                 String
  email                String     @unique
  password             String
  role                 Role
  status               UserStatus @default(ACTIVO)
  isNewAdvisor         Boolean    @default(true)
  lastProspectAssigned DateTime?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  sessions             Session[]
  Quote                Quote[]

  @@schema("auth")
}

enum InsuranceStatus {
  ACTIVO
  INACTIVO

  @@schema("public")
}

model Insurance {
  id          String          @id @default(uuid()) @db.Uuid
  name        String          @unique
  logo        String          @db.Text
  description String?
  status      InsuranceStatus @default(ACTIVO)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  plans       Plan[]

  @@schema("public")
}

enum PlanTypeStatus {
  ACTIVO
  INACTIVO

  @@schema("public")
}

model PlanType {
  id         String         @id @default(uuid()) @db.Uuid
  name       String
  status     PlanTypeStatus @default(ACTIVO)
  orderIndex Int            @default(0)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @default(now())
  Plan       Plan[]

  @@schema("public")
}

enum PlanStatus {
  ACTIVO
  INACTIVO

  @@schema("public")
}

model Plan {
  id                 String     @id @default(uuid()) @db.Uuid
  planType           PlanType   @relation(fields: [planTypeId], references: [id], onDelete: Cascade)
  planTypeId         String     @db.Uuid
  company            Insurance  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId          String     @db.Uuid
  sumInsured         Float
  coInsurance        Json
  coInsuranceCap     Json?
  status             PlanStatus @default(ACTIVO)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  additionalInfoHtml String?
  isRecommended      Boolean    @default(false)
  prices             Json
  deductibles        Json

  @@schema("public")
}

model Prospect {
  id         String   @id @default(uuid()) @db.Uuid
  name       String
  gender     String
  age        Int?
  postalCode String
  whatsapp   String
  email      String
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  quotes     Quote[]

  @@schema("public")
}

enum QuoteStatus {
  NUEVO
  CONTACTADO
  EN_PROGRESO
  CERRADO

  @@schema("public")
}

model Quote {
  id                    String          @id @default(uuid()) @db.Uuid
  prospect              Prospect        @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  prospectId            String          @db.Uuid
  planData              Json
  totalPrice            Float
  status                QuoteStatus     @default(NUEVO)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  trackingNumber        TrackingNumber?
  expirationDate        DateTime?
  protectWho            String
  additionalInfo        Json?
  medicalHistories      Json[]
  userId                String?         @db.Uuid
  user                  User?           @relation(fields: [userId], references: [id])
  lastContactDate       DateTime?
  coverageFee           Float
  paymentType           String
  sumInsured            Float
  deductible            Float
  coInsurance           Float
  coInsuranceCap        Float
  membersData           Json? // Almacenará el array de miembros con sus precios
  isMultipleDeductible  Boolean         @default(false)
  deductiblesData       Json? // Para almacenar múltiples deducibles si aplica
  isMultipleCoInsurance Boolean         @default(false)
  coInsuranceData       Json? // Para almacenar múltiples coaseguros si aplica
  coInsuranceCapData    Json? // Para almacenar múltiples topes de coaseguro si aplica

  @@schema("public")
}

model TrackingNumber {
  id           String   @id @default(uuid()) @db.Uuid
  number       String   @unique
  quote        Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteId      String   @unique @db.Uuid
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastActivity DateTime @default(now())
  activityLog  Json?

  @@schema("public")
}
